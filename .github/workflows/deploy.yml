name: Deploy

on:
    push:
        branches:
            - main
            - develop
    workflow_dispatch:
        inputs:
            environment:
                description: 'Deployment environment'
                required: true
                default: 'staging'
                type: choice
                options:
                    - staging
                    - production
            skip_tests:
                description: 'Skip tests before deployment'
                required: false
                default: false
                type: boolean

env:
    NODE_VERSION: '20'
    PNPM_VERSION: '8'

jobs:
    pre-deployment:
        name: Pre-deployment Checks
        runs-on: ubuntu-latest
        outputs:
            environment: ${{ steps.environment.outputs.environment }}
            deploy_version: ${{ steps.version.outputs.version }}

        steps:
            - name: Determine deployment environment
              id: environment
              run: |
                  if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
                    echo "environment=${{ github.event.inputs.environment }}" >> $GITHUB_OUTPUT
                  elif [ "${{ github.ref }}" = "refs/heads/main" ]; then
                    echo "environment=production" >> $GITHUB_OUTPUT
                  else
                    echo "environment=staging" >> $GITHUB_OUTPUT
                  fi

            - name: Get deployment version
              id: version
              run: |
                  VERSION=$(node -p "require('./package.json').version")
                  TIMESTAMP=$(date +%Y%m%d-%H%M%S)
                  echo "version=$VERSION-$TIMESTAMP" >> $GITHUB_OUTPUT
                  echo "Deployment version: $VERSION-$TIMESTAMP"

    security-scan:
        name: Security Scan
        runs-on: ubuntu-latest
        needs: pre-deployment

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Run Trivy vulnerability scanner
              uses: aquasecurity/trivy-action@master
              with:
                  scan-type: 'fs'
                  scan-ref: '.'
                  format: 'sarif'
                  output: 'trivy-results.sarif'

            - name: Upload Trivy scan results
              uses: github/codeql-action/upload-sarif@v3
              with:
                  sarif_file: 'trivy-results.sarif'

    test-deployment:
        name: Test Deployment
        runs-on: ubuntu-latest
        needs: [pre-deployment, security-scan]
        if: ${{ github.event.inputs.skip_tests != 'true' }}

        strategy:
            matrix:
                node-version: [18, 20]

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Node.js ${{ matrix.node-version }}
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ matrix.node-version }}

            - name: Setup PNPM
              uses: pnpm/action-setup@v2
              with:
                  version: ${{ env.PNPM_VERSION }}

            - name: Install dependencies
              run: pnpm install --frozen-lockfile

            - name: Build application
              run: pnpm build

            - name: Start application
              run: |
                  pnpm start &
                  sleep 10
              env:
                  NODE_ENV: test

            - name: Health check
              run: |
                  curl -f http://localhost:3000/health || exit 1

            - name: Run smoke tests
              run: |
                  # Add smoke test commands here
                  echo "Running smoke tests..."

    build-and-deploy:
        name: Build and Deploy
        runs-on: ubuntu-latest
        needs: [pre-deployment, security-scan]

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ env.NODE_VERSION }}

            - name: Setup PNPM
              uses: pnpm/action-setup@v2
              with:
                  version: ${{ env.PNPM_VERSION }}

            - name: Install dependencies
              run: pnpm install --frozen-lockfile

            - name: Build application
              run: pnpm build

            - name: Build Docker image
              run: |
                  docker build -t ${{ needs.pre-deployment.outputs.environment }}-crefy-backend:${{ needs.pre-deployment.outputs.deploy_version }} .

            - name: Tag for registry
              run: |
                  docker tag ${{ needs.pre-deployment.outputs.environment }}-crefy-backend:${{ needs.pre-deployment.outputs.deploy_version }} ${{ secrets.DOCKER_REGISTRY }}/${{ needs.pre-deployment.outputs.environment }}-crefy-backend:${{ needs.pre-deployment.outputs.deploy_version }}

            - name: Push to registry
              run: |
                  echo "${{ secrets.DOCKER_REGISTRY_PASSWORD }}" | docker login ${{ secrets.DOCKER_REGISTRY }} -u ${{ secrets.DOCKER_REGISTRY_USERNAME }} --password-stdin
                  docker push ${{ secrets.DOCKER_REGISTRY }}/${{ needs.pre-deployment.outputs.environment }}-crefy-backend:${{ needs.pre-deployment.outputs.deploy_version }}

            - name: Deploy to ${{ needs.pre-deployment.outputs.environment }}
              run: |
                  # Add deployment commands based on your infrastructure
                  # This could be kubectl, docker-compose, or other deployment tools
                  echo "Deploying to ${{ needs.pre-deployment.outputs.environment }} environment..."
                  echo "Image: ${{ secrets.DOCKER_REGISTRY }}/${{ needs.pre-deployment.outputs.environment }}-crefy-backend:${{ needs.pre-deployment.outputs.deploy_version }}"

            - name: Wait for deployment
              run: |
                  # Wait for the deployment to be ready
                  echo "Waiting for deployment to be ready..."
                  sleep 30

            - name: Health check after deployment
              run: |
                  # Perform health check on deployed application
                  if [ "${{ needs.pre-deployment.outputs.environment }}" = "production" ]; then
                    curl -f https://api.production.crefy.com/health || exit 1
                  else
                    curl -f https://api.staging.crefy.com/health || exit 1
                  fi

    post-deployment:
        name: Post-deployment Verification
        runs-on: ubuntu-latest
        needs: [pre-deployment, build-and-deploy]

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Run API tests
              run: |
                  # Run API integration tests against the deployed environment
                  BASE_URL=$( [ "${{ needs.pre-deployment.outputs.environment }}" = "production" ] && echo "https://api.production.crefy.com" || echo "https://api.staging.crefy.com" )
                  echo "Testing API at: $BASE_URL"

                  # Add your API test commands here
                  echo "Running API integration tests..."

            - name: Update deployment record
              run: |
                  # Update deployment tracking system
                  echo "Recording deployment: ${{ needs.pre-deployment.outputs.environment }} v${{ needs.pre-deployment.outputs.deploy_version }}"

            - name: Notify deployment success
              if: success()
              run: |
                  echo "Deployment to ${{ needs.pre-deployment.outputs.environment }} completed successfully!"

            - name: Notify deployment failure
              if: failure()
              run: |
                  echo "Deployment to ${{ needs.pre-deployment.outputs.environment }} failed!"
                  exit 1

    rollback:
        name: Rollback on Failure
        runs-on: ubuntu-latest
        needs: [pre-deployment, build-and-deploy]
        if: failure() && needs.pre-deployment.outputs.environment == 'production'

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Rollback production deployment
              run: |
                  echo "Rolling back production deployment..."
                  # Add rollback commands here
                  # This should revert to the previous working version

            - name: Verify rollback
              run: |
                  echo "Verifying rollback..."
                  curl -f https://api.production.crefy.com/health || exit 1

            - name: Notify rollback
              run: |
                  echo "Production deployment rolled back successfully!"
